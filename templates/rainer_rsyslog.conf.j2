# {{ ansible_managed }}

#  /etc/rsyslog.conf	Configuration file for rsyslog.
#
#			For more information see
#			/usr/share/doc/rsyslog-doc/html/rsyslog_conf.html
#
#  Default logging rules can be found in /etc/rsyslog.d/50-default.conf

#################
#### MODULES ####
#################

{% for module in rsyslog_modules %}
module(load="{{ module.type }}") # {{ module.comment|default('') }}
{% endfor %}

{% if rsyslog_input_udp is defined %}
# UDP input
module(load="{{ rsyslog_input_udp.type|default('imudp') }}")
input(type="{{ rsyslog_input_udp.type|default('imudp') }}" address="{{ rsyslog_input_udp.address|default('*') }}" port="{{ rsyslog_input_udp.port|default(514) }}")
{% endif %}

{% if rsyslog_input_tcp is defined %}
{%   if rsyslog_server_tls is defined %}
# TLS certs
global(
  defaultNetstreamDriver="gtls" 
  defaultNetstreamDriverCAFile="{{ rsyslog_server_tls.cafile }}"
  defaultNetstreamDriverCertFile="{{ rsyslog_server_tls.certfile }}"
  defaultNetstreamDriverKeyFile="{{ rsyslog_server_tls.keyfile }}"
)
{%   endif %}

# TCP input
{%   if rsyslog_server_tls is defined %}
module(
  load="{{ rsyslog_input_tcp.type|default('imtcp') }}"
  streamDriver.name="gtls"
  streamDriver.mode="{{ rsyslog_server_tls.drivermode|default(1) }}"
  streamDriver.authMode="{{ rsyslog_server_tls.authmode|default('anon') }}"
)
{%   else %}
module(load="{{ rsyslog_input_tcp.type|default('imtcp') }}")
{%   endif %}
input(type="{{ rsyslog_input_tcp.type|default('imtcp') }}" address="{{ rsyslog_input_tcp.address|default('*') }}" port="{{ rsyslog_input_tcp.port|default(514) }}")
{% endif %}

{% if rsyslog_input_relp is defined %}
# RELP input
module(load="{{ rsyslog_input_relp.type|default('imrelp') }}")
input(
    type="{{ rsyslog_input_relp.type|default('imrelp') }}" 
    port="{{ rsyslog_input_relp.port|default(514) }}"
{%   if rsyslog_server_tls is defined %}
    tls="on"
{%     if rsyslog_server_tls.compression|d(false) -%}    tls.compression="on"{% endif %}
    tls.caCert="{{ rsyslog_server_tls.cafile }}"
    tls.myCert="{{ rsyslog_server_tls.certfile }}"
    tls.myPrivKey="{{ rsyslog_server_tls.keyfile }}"
    tls.authMode="{{ rsyslog_server_tls.authmode|default('anon') }}"
{%     if rsyslog_server_tls.dhbits|d(0)|int > 0 -%}    tls.dhbits={{ rsyslog_server_tls.dhbits }}{% endif %}
{%     if rsyslog_server_tls.permittedPeer|d('') != '' -%}    tls.permittedPeer="{{ rsyslog_server_tls.permittedPeer }}"{% endif %}
{%   endif %}
)
{% endif %}

###########################
#### TEMPLATES
###########################
{% for template in rsyslog_templates -%}
template (name="{{ template.name }}" type="{{ template.type|default('string')}}" 
    string="{{ template.string }}"
)
{%- endfor %}

###########################
#### RULESETS
###########################

{{ rsyslog_rulesets }}

###########################
#### GLOBAL DIRECTIVES ####
###########################

#
# Use traditional timestamp format.
# To enable high precision timestamps, comment out the following line.
#
$ActionFileDefaultTemplate {{ rsyslog_action.file_default_template }}

{% if rsyslog_action.queue_filename is defined %}
$ActionQueueFileName {{ rsyslog_action.queue_filename }}     # unique name prefix for spool files
{% endif %}
$ActionQueueMaxDiskSpace  {{ rsyslog_action.queue_maxdiskspace|default('100mb') }}     # 1gb space limit (use as much as possible)
$ActionQueueSaveOnShutdown {{ rsyslog_action.queue_saveonshutdown|default('on') }}     # save messages to disk on shutdown
$ActionQueueType {{ rsyslog_action.queue_type|default('LinkedList') }}       # run asynchronously
$ActionResumeRetryCount {{ rsyslog_action.resume_retrycount|default(-1) }}        # infinite retries if host is down

# Filter duplicated messages
$RepeatedMsgReduction {{ rsyslog_repeated_msg_reduction }}

#
# Set the default permissions for all log files.
#
$FileOwner {{ rsyslog_file_owner }}
$FileGroup {{ rsyslog_file_group }}
$FileCreateMode {{ rsyslog_file_create_mode }}
$DirCreateMode {{ rsyslog_dir_create_mode }}
$Umask {{ rsyslog_umask }}
$PrivDropToUser {{ rsyslog_priv_drop_to_user }}
$PrivDropToGroup {{ rsyslog_priv_drop_to_group }}

#
# Where to place spool and state files
#
$WorkDirectory {{ rsyslog_work_directory }}

#
# Include all config files in /etc/rsyslog.d/
#
$IncludeConfig {{ rsyslog_include_config }}

# File to store the position in the journal
$IMJournalStateFile imjournal.state
