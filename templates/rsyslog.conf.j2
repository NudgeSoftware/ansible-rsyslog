# {{ ansible_managed }}

#  /etc/rsyslog.conf	Configuration file for rsyslog.
#
#			For more information see
#			/usr/share/doc/rsyslog-doc/html/rsyslog_conf.html
#
#  Default logging rules can be found in /etc/rsyslog.d/50-default.conf

#################
#### MODULES ####
#################

{% for module in rsyslog_modules %}
$ModLoad {{ module.type }} # {{ module.comment|default('') }}
{% endfor %}
# Enable non-kernel facility klog messages
$KLogPermitNonKernelFacility {{ rsyslog_klog_permit_non_kernel_facility }}

{% if rsyslog_input_udp is defined %}
# UDP input
$ModLoad {{ rsyslog_input_udp.type|default('imudp') }}
$UDPServerAddress {{ rsyslog_input_udp.address|default('*') }}
$UDPServerRun {{ rsyslog_input_udp.port|default(514) }}
{% endif %}

{% if rsyslog_server_tls is defined %}
# TLS certs
$DefaultNetstreamDriver gtls
$DefaultNetstreamDriverCAFile {{ rsyslog_server_tls.cafile|quote }}
$DefaultNetstreamDriverCertFile {{ rsyslog_server_tls.certfile|quote }}
$DefaultNetstreamDriverKeyFile {{ rsyslog_server_tls.keyfile|quote }}
{% endif %}

{% if rsyslog_input_tcp is defined %}
# TCP input
$ModLoad {{ rsyslog_input_tcp.type|default('imtcp') }}
$InputTCPServerAddress {{ rsyslog_input_tcp.address|default('*') }}
{%   if rsyslog_server_tls is defined %}
$InputTCPServerStreamDriverMode {{ rsyslog_server_tls.drivermode|default(1) }}
$InputTCPServerStreamDriverAuthMode {{ rsyslog_server_tls.authmode|default('anon') }}
{%   endif %}
$InputTCPServerRun {{ rsyslog_input_tcp.port|default(514) }}
{% endif %}

{% if rsyslog_input_relp is defined %}
# RELP input
$ModLoad {{ rsyslog_input_relp.type|default('imrelp') }}
$InputRELPServerRun  {{ rsyslog_input_relp.port|default(514) }}
{% endif %}

{% if rsyslog_client_tls is defined %}
$DefaultNetstreamDriverCAFile {{ rsyslog_client_tls.cafile|quote }}
$DefaultNetstreamDriver gtls
$InputTCPServerStreamDriverMode {{ rsyslog_client_tls.drivermode|default(1) }}
$InputTCPServerStreamDriverAuthMode {{ rsyslog_client_tls.authmode|default('anon') }}
{% endif %}

###########################
#### TEMPLATES
###########################
{% for template in rsyslog_templates -%}
$template {{ template.name }},"{{ template.string }}"
{%- endfor %}

###########################
#### RULESETS
###########################

{{ rsyslog_rulesets }}

###########################
#### GLOBAL DIRECTIVES ####
###########################

#
# Use traditional timestamp format.
# To enable high precision timestamps, comment out the following line.
#
$ActionFileDefaultTemplate {{ rsyslog_action.file_default_template }}

{% if rsyslog_action.queue_filename is defined %}
$ActionQueueFileName {{ rsyslog_action.queue_filename }}     # unique name prefix for spool files
{% endif %}
$ActionQueueMaxDiskSpace  {{ rsyslog_action.queue_maxdiskspace|default('100mb') }}     # 1gb space limit (use as much as possible)
$ActionQueueSaveOnShutdown {{ rsyslog_action.queue_saveonshutdown|default('on') }}     # save messages to disk on shutdown
$ActionQueueType {{ rsyslog_action.queue_type|default('LinkedList') }}       # run asynchronously
$ActionResumeRetryCount {{ rsyslog_action.resume_retrycount|default(-1) }}        # infinite retries if host is down

# Filter duplicated messages
$RepeatedMsgReduction {{ rsyslog_repeated_msg_reduction }}

#
# Set the default permissions for all log files.
#
$FileOwner {{ rsyslog_file_owner }}
$FileGroup {{ rsyslog_file_group }}
$FileCreateMode {{ rsyslog_file_create_mode }}
$DirCreateMode {{ rsyslog_dir_create_mode }}
$Umask {{ rsyslog_umask }}
$PrivDropToUser {{ rsyslog_priv_drop_to_user }}
$PrivDropToGroup {{ rsyslog_priv_drop_to_group }}

# Tell rsyslog what to do with oversized messages
global(oversizemsg.input.mode="truncate")
global(internalmsg.severity="warn")
global(maxMessageSize="16K")

#
# Where to place spool and state files
#
$WorkDirectory {{ rsyslog_work_directory }}

#
# Include all config files in /etc/rsyslog.d/
#
$IncludeConfig {{ rsyslog_include_config }}

# File to store the position in the journal
$IMJournalStateFile imjournal.state
